<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <form onsubmit="return false;" class='autocomplete-container'>
    <div class='autocomplete' role='combobox' aria-expanded='false' aria-owns='autocomplete-results'
      aria-haspopup='listbox'>
      <input class='autocomplete-input' draggable="true" placeholder='Search in mTool' aria-label='Search in mTool'
        aria-autocomplete='both' aria-controls='autocomplete-results'>
    </div>
    <ul id='autocomplete-results' class='autocomplete-results hidden' role='listbox' aria-label='Search in mTool'>
    </ul>
  </form>
  <script src="./autocomplete.js"></script>
  <script>
    const input = document.querySelector('input');
    setTimeout(() => {
      input.focus();
    }, 0);
    window.addEventListener('toggle-window-event', (event) => {
      const isHidden = event.isHidden;
      isHidden ? input.focus() : input.blur();
    });
    input.addEventListener('focus', () => {
      window.electronAPI.showOptions(true)
    });
    input.addEventListener('blur', () => {
      window.electronAPI.showOptions(false)
    });
    let data = [];

    (async () => {
      data = await window.electronAPI.getJsonData();
    })()

    input.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && !autocomplete.shown) {
        await runExec(data.find(item => item.value === input.value).label);
      }
    });

    async function runExec(cmd) {
      try {
        await window.electronAPI.exec(cmd);
        input.select();
      } catch (error) {
        console.error(error);
      }
    }

    const search = data => {
      return (input) => {
        if (input.length < 1) {
          return []
        }
        return data.filter(item => item.label.toLowerCase().includes(input.toLowerCase()))
      }
    }

    const autocomplete = new Autocomplete({
      rootNode: document.querySelector('.autocomplete'),
      inputNode: document.querySelector('.autocomplete-input'),
      resultsNode: document.querySelector('.autocomplete-results'),
      searchFn: search,
      data: data,
      shouldAutoSelect: true,
      onShow: async () => {
        const json = await window.electronAPI.getJsonData();
        console.log(json)
        return json
      }
    })

    addEventListener("drop", function dropHandler(ev) {
      ev.preventDefault();
      const file = ev.dataTransfer.items[0].getAsFile();
      window.electronAPI.uploadFilePath(file.path);
    })
  </script>
</body>

</html>